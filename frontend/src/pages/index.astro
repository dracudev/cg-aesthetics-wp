---
import Layout from '../layouts/Layout.astro';
import { Button } from '../components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';
import OptimizedImage from '../components/OptimizedImage.astro';
import { query } from '../lib/apollo-client';
import { GET_SITE_SETTINGS, GET_FEATURED_SERVICES, GET_FEATURED_TESTIMONIALS } from '../lib/queries';
import { buildAggregateRatingSchema } from '../lib/seo';
import type { SiteSettingsResponse, ServicesResponse, TestimonialsResponse } from '../types/wordpress';
import { Sparkles, Clock, Star, CheckCircle2, Calendar } from 'lucide-react';

// Fetch data from WordPress
let siteSettings;
let featuredServices: Array<any> = [];
let featuredTestimonials: Array<any> = [];
let error: string | null = null;

try {
  const settingsData = await query<SiteSettingsResponse>(GET_SITE_SETTINGS);
  siteSettings = settingsData.generalSettings;

  const servicesData = await query<ServicesResponse>(GET_FEATURED_SERVICES, { first: 3 });
  featuredServices = servicesData.services.nodes;

  const testimonialsData = await query<TestimonialsResponse>(GET_FEATURED_TESTIMONIALS, { first: 3 });
  featuredTestimonials = testimonialsData.testimonials.nodes;
} catch (e) {
  console.error('Error fetching data from WordPress:', e);
  error = e instanceof Error ? e.message : 'Failed to fetch data from WordPress';
}

// SEO Configuration
const seoTitle = siteSettings?.title 
  ? `${siteSettings.title} - Institut de Beauté à Montreux` 
  : 'CG Aesthetics - Institut de Beauté & Bien-être à Montreux, Suisse';

const seoDescription = siteSettings?.description 
  || 'Institut de beauté de luxe à Montreux, Suisse. Soins du visage, massages, épilation et traitements esthétiques dans un cadre serein au bord du Lac Léman. Réservez votre rendez-vous.';

const ogImage = featuredServices[0]?.featuredImage?.node?.sourceUrl;

// Build aggregate rating schema
let aggregateRatingSchema;
if (featuredTestimonials && featuredTestimonials.length > 0) {
  const ratings = featuredTestimonials
    .map(t => t.testimonialDetails?.rating)
    .filter(r => r !== undefined);
  
  if (ratings.length > 0) {
    aggregateRatingSchema = buildAggregateRatingSchema(ratings, featuredTestimonials.length);
  }
}

const benefits = [
  { icon: Sparkles, title: 'Produits Premium', description: 'Soins avec des produits haut de gamme soigneusement sélectionnés' },
  { icon: Star, title: 'Expertise Reconnue', description: 'Équipe d\'esthéticiennes diplômées et passionnées' },
  { icon: Clock, title: 'Flexibilité', description: 'Horaires étendus et réservation en ligne simplifiée' },
  { icon: CheckCircle2, title: 'Satisfaction Garantie', description: 'Votre bien-être est notre priorité absolue' },
];
---

<Layout 
  title={seoTitle}
  description={seoDescription}
  image={ogImage}
  type="website"
  schema={aggregateRatingSchema}
>
  <main>
    <!-- Hero Section -->
    <section class="relative overflow-hidden min-h-[70vh] flex items-center justify-center">
      <!-- Background Image -->
      <div class="absolute inset-0 z-0">
        <OptimizedImage
          src="https://images.unsplash.com/photo-1540555700478-4be289fbecef?q=80&w=2670&auto=format&fit=crop"
          alt="Spa relaxation avec bougies et serviettes"
          width={2670}
          height={1440}
          class="w-full h-full object-cover"
          loading="eager"
        />
        <div class="absolute inset-0 bg-gradient-to-b from-black/40 via-black/30 to-black/50"></div>
      </div>

      <!-- Content -->
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-20 md:py-32 relative z-10">
        <div class="max-w-4xl mx-auto text-center space-y-8">
          <div class="space-y-4">
            <p class="text-sm md:text-base font-medium tracking-[var(--letter-spacing-widest)] uppercase text-white/90">
              Institut de Beauté & Bien-être
            </p>
            <h1 
              class="text-4xl md:text-6xl lg:text-7xl font-[var(--font-weight-bold)] leading-[var(--line-height-tight)] tracking-[var(--letter-spacing-tight)] text-white"
              style="font-family: var(--font-heading);"
            >
              Révélez Votre
              <span class="block mt-2" style="color: var(--color-accent-rose-gold-light);">Beauté Naturelle</span>
            </h1>
            <p 
              class="text-lg md:text-xl max-w-2xl mx-auto leading-[var(--line-height-relaxed)] text-white/95"
              style="font-size: var(--font-size-body-lg);"
            >
              Offrez-vous un moment d'exception dans notre sanctuaire dédié à votre bien-être. 
              Des soins personnalisés dans une atmosphère sereine et luxueuse.
            </p>
          </div>
          
          <div class="flex flex-col sm:flex-row gap-4 justify-center items-center pt-4">
            <a href="/reserver" class="w-full sm:w-auto">
              <Button 
                size="lg"
                className="w-full gap-2 text-base px-8 py-6 rounded-[var(--radius-pill)] shadow-[var(--shadow-large)] bg-[var(--color-accent-rose-gold)] hover:bg-[var(--color-accent-rose-gold-dark)]"
                client:load
              >
                <Calendar className="h-5 w-5" />
                Réserver un Rendez-vous
              </Button>
            </a>
            <a href="/services" class="w-full sm:w-auto">
              <Button 
                variant="outline"
                size="lg"
                className="w-full text-base px-8 py-6 rounded-[var(--radius-pill)] border-2 border-[var(--color-white)] bg-transparent text-[var(--color-white)] hover:bg-[var(--color-white)] hover:text-[var(--color-secondary-mauve)]"
                client:load
              >
                Découvrir nos Services
              </Button>
            </a>
          </div>
        </div>
      </div>
    </section>


    <!-- Benefits Section -->
    <section class="py-16 md:py-24" style="background-color: var(--color-white);">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center max-w-3xl mx-auto mb-16 space-y-4">
          <h2 
            class="text-3xl md:text-5xl font-[var(--font-weight-semibold)] tracking-[var(--letter-spacing-wide)]"
            style="font-family: var(--font-heading); color: var(--color-text-heading);"
          >
            L'Excellence à Votre Service
          </h2>
          <p style="color: var(--color-text-muted); font-size: var(--font-size-body-lg); line-height: var(--line-height-relaxed);">
            Découvrez pourquoi nos clientes nous font confiance pour sublimer leur beauté naturelle
          </p>
        </div>

        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-8">
          {benefits.map(({ icon: Icon, title, description }) => (
            <div class="text-center space-y-4 group">
              <div 
                class="inline-flex p-4 rounded-full transition-all duration-300 group-hover:scale-110"
                style="background-color: var(--color-secondary-gray-light);"
              >
                <Icon 
                  className="h-8 w-8 text-[var(--color-accent-rose-gold)]"
                />
              </div>
              <h3 
                class="text-xl font-[var(--font-weight-semibold)]"
                style="color: var(--color-text-heading); font-family: var(--font-body);"
              >
                {title}
              </h3>
              <p 
                class="text-sm leading-relaxed"
                style="color: var(--color-text-muted);"
              >
                {description}
              </p>
            </div>
          ))}
        </div>
      </div>
    </section>


    <!-- Featured Services -->
    {!error && featuredServices && featuredServices.length > 0 && (
      <section class="py-16 md:py-24" style="background-color: var(--color-secondary-gray-light);">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center max-w-3xl mx-auto mb-16 space-y-4">
            <h2 
              class="text-3xl md:text-5xl font-[var(--font-weight-semibold)] tracking-[var(--letter-spacing-wide)]"
              style="font-family: var(--font-heading); color: var(--color-text-heading);"
            >
              Nos Soins Signature
            </h2>
            <p style="color: var(--color-text-muted); font-size: var(--font-size-body-lg); line-height: var(--line-height-relaxed);">
              Des soins sur-mesure pour répondre à tous vos besoins de beauté et bien-être
            </p>
          </div>

          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
            {featuredServices.map((service) => (
              <Card client:visible noTopPadding className="group border-0 transition-all duration-500 hover:-translate-y-2">
                {service.featuredImage?.node.sourceUrl && (
                  <div class="relative overflow-hidden aspect-[4/3] rounded-t-xl">
                    <OptimizedImage
                      src={service.featuredImage.node.sourceUrl} 
                      alt={service.featuredImage.node.altText || service.title}
                      width={400}
                      height={300}
                      sizes="(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 33vw"
                      class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                      loading="lazy"
                    />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                  </div>
                )}
                <CardHeader>
                  <CardTitle client:load>{service.title}</CardTitle>
                  <div class="flex justify-between items-center pt-2">
                    <span 
                      class="text-2xl font-[var(--font-weight-bold)]"
                      style="color: var(--color-accent-rose-gold); font-family: var(--font-heading);"
                    >
                      {service.serviceDetails.servicePrice}
                    </span>
                    <span 
                      class="flex items-center gap-1 text-sm"
                      style="color: var(--color-text-muted);"
                    >
                      <Clock className="h-4 w-4" />
                      {service.serviceDetails.serviceDuration} min
                    </span>
                  </div>
                </CardHeader>
                <CardContent client:load>
                  <CardDescription client:load set:html={service.excerpt} />
                  <div class="mt-6">
                    <a 
                      href={`/services/${service.slug}`}
                      class="inline-flex items-center gap-2 font-[var(--font-weight-medium)] transition-colors"
                      style="color: var(--color-secondary-mauve);"
                    >
                      En savoir plus
                      <span class="transition-transform group-hover:translate-x-1">→</span>
                    </a>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>

          <div class="text-center mt-12">
            <a href="/services">
              <Button 
                variant="outline"
                size="lg"
                className="rounded-[var(--radius-pill)] px-8"
                client:load
              >
                Voir tous nos services
              </Button>
            </a>
          </div>
        </div>
      </section>
    )}


    <!-- Testimonials -->
    {!error && featuredTestimonials && featuredTestimonials.length > 0 && (
      <section class="py-16 md:py-24" style="background-color: var(--color-white);">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center max-w-3xl mx-auto mb-16 space-y-4">
            <h2 
              class="text-3xl md:text-5xl font-[var(--font-weight-semibold)] tracking-[var(--letter-spacing-wide)]"
              style="font-family: var(--font-heading); color: var(--color-text-heading);"
            >
              Elles Nous Font Confiance
            </h2>
            <p style="color: var(--color-text-muted); font-size: var(--font-size-body-lg); line-height: var(--line-height-relaxed);">
              Découvrez les avis de nos clientes satisfaites
            </p>
          </div>

          <div class="grid md:grid-cols-3 gap-8">
            {featuredTestimonials.map((testimonial) => (
              <Card client:visible className="border-0 transition-all duration-300 hover:shadow-[var(--shadow-blush)]">
                <CardContent client:load className="pt-6 space-y-4">
                  <div class="flex gap-1">
                    {[...Array(5)].map((_, i) => (
                      <Star 
                        key={i}
                        className={`h-5 w-5 ${i < testimonial.testimonialDetails.rating ? 'fill-current text-[var(--color-accent-rose-gold)]' : 'text-[var(--color-secondary-gray)]'}`}
                      />
                    ))}
                  </div>
                  <blockquote 
                    class="text-base leading-[var(--line-height-relaxed)] italic"
                    style="color: var(--color-text-body);"
                  >
                    "{testimonial.testimonialDetails.reviewText}"
                  </blockquote>
                  <div class="pt-4 border-t" style="border-color: var(--color-secondary-gray);">
                    <p 
                      class="font-[var(--font-weight-semibold)]"
                      style="color: var(--color-text-heading);"
                    >
                      {testimonial.testimonialDetails.clientName}
                    </p>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- CTA Section -->
    <section 
      class="py-20 md:py-32 relative overflow-hidden"
      style="background: linear-gradient(135deg, var(--color-accent-rose-gold) 0%, var(--color-secondary-mauve) 100%);"
    >
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
        <div class="max-w-3xl mx-auto text-center space-y-8">
          <h2 
            class="text-3xl md:text-5xl font-[var(--font-weight-bold)] tracking-[var(--letter-spacing-wide)] text-white"
            style="font-family: var(--font-heading);"
          >
            Prête à Vous Offrir un Moment d'Exception ?
          </h2>
          <p class="text-lg md:text-xl text-white/90 leading-[var(--line-height-relaxed)] max-w-2xl mx-auto">
            Réservez dès maintenant votre rendez-vous et laissez nos expertes sublimer votre beauté naturelle
          </p>
          <div class="flex flex-col sm:flex-row gap-4 justify-center items-center pt-4">
            <a href="/reserver" class="w-full sm:w-auto">
              <Button 
                size="lg"
                className="w-full gap-2 text-base px-10 py-6 rounded-[var(--radius-pill)] bg-[var(--color-white)] text-[var(--color-accent-rose-gold)] hover:bg-[var(--color-primary-background)] shadow-[var(--shadow-large)] transition-[var(--transition-interactive)]"
                client:load
              >
                <Calendar className="h-5 w-5" />
                Prendre Rendez-vous
              </Button>
            </a>
            <a href="/contact" class="w-full sm:w-auto">
              <Button 
                variant="outline"
                size="lg"
                className="w-full text-base px-10 py-6 rounded-[var(--radius-pill)] border-2 border-[var(--color-white)] bg-transparent text-[var(--color-white)] hover:bg-[var(--color-white)] hover:text-[var(--color-secondary-mauve)] transition-[var(--transition-interactive)]"
                client:load
              >
                Nous Contacter
              </Button>
            </a>
          </div>
        </div>
      </div>
      
      <!-- Decorative circles -->
      <div class="absolute top-10 right-10 w-64 h-64 rounded-full opacity-10 bg-white blur-3xl"></div>
      <div class="absolute bottom-10 left-10 w-96 h-96 rounded-full opacity-10 bg-white blur-3xl"></div>
    </section>
  </main>
</Layout>
